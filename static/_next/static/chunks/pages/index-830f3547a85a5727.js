(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[405],{5557:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){return s(7229)}])},7229:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return x}});var l=s(5893);s(9008);var n=s(7294);function a(e){let{children:t,color:s="rgb(59 130 246)"}=e;return(0,l.jsx)("div",{className:"bg-blue-500 w-[45px] h-[45px] flex items-center justify-center rounded-full",style:{backgroundColor:s},children:(0,l.jsx)("span",{className:"font-bold text-sm text-white",children:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(e.includes(" ")){let t=e.split(" ");return"".concat(t[0].charAt(0)).concat(t[1].charAt(0)).toUpperCase()}return"".concat(e.slice(0,2)).toUpperCase()}(t)})})}var r=s(6154);function o(e){let{onSelect:t,room:s,userId:n,index:r,selectedItem:o}=e,{users:c,created_at:i,last_message:d}=s,u=r==o,x=new Date(i),m=x.getHours()>=12?"PM":"AM",h="".concat(x.getHours(),":").concat(x.getMinutes()," ").concat(m),g=null==c?void 0:c.filter(e=>e.id!=n).map(e=>e.username)[0];return(0,l.jsx)("div",{onClick:()=>t(r,{}),className:"".concat(u?"bg-[#FDF9F0] border border-[#DEAB6C]":"bg-[#FAF9FE] border border-[#FAF9FE]"," p-2 rounded-[10px] shadow-sm cursor-pointer"),children:(0,l.jsxs)("div",{className:"flex justify-between items-center gap-3",children:[(0,l.jsxs)("div",{className:"flex gap-3 items-center w-full",children:[(0,l.jsx)(a,{children:g}),(0,l.jsxs)("div",{className:"w-full max-w-[150px]",children:[(0,l.jsx)("h3",{className:"font-semibold text-sm text-gray-700",children:g}),(0,l.jsx)("p",{className:"font-light text-xs text-gray-600 truncate",children:d})]})]}),(0,l.jsx)("div",{className:"text-gray-400 min-w-[55px]",children:(0,l.jsx)("span",{className:"text-xs",children:h})})]})})}function c(e){let{onChatChange:t,userId:s}=e,[a,c]=(0,n.useState)([]),[i,d]=(0,n.useState)(!1),[u,x]=(0,n.useState)(-1),m=async e=>{await r.Z.get("http://localhost:8080/rooms/user/".concat(e)).then(e=>{let t=e.data;c(t),d(!1)}).catch(e=>console.log(e))};(0,n.useEffect)(()=>{d(!0),m(s)},[]);let h=(e,s)=>{x(e);let l=new Map;s.users.forEach(e=>{l.set(e.id,e)}),console.log(l),t({...s.room,users:{get:e=>(console.log("id in mapUsers: "+e),l.get(e).username),get_target_user:e=>s.users.filter(t=>t.id!=e).map(e=>e.username).join("")}})};return(0,l.jsxs)("div",{className:"overflow-hidden space-y-3",children:[i&&(0,l.jsx)("p",{children:"Loading chat lists."}),a.map((e,t)=>(0,l.jsx)(o,{onSelect:t=>h(t,e),room:{...e.room,users:e.users},index:t,userId:s,selectedItem:u},e.room.id))]})}function i(e){let{right:t,content:s,username:n}=e;return t?(0,l.jsx)("div",{className:"w-full flex justify-end",children:(0,l.jsxs)("div",{className:"flex gap-3 justify-end",children:[(0,l.jsx)("div",{className:"max-w-[65%] bg-violet-500 p-3 text-sm rounded-xl rounded-br-none",children:(0,l.jsx)("p",{className:"text-white",children:s})}),(0,l.jsx)("div",{className:"mt-auto",children:(0,l.jsx)(a,{children:n})})]})}):(0,l.jsxs)("div",{className:"flex gap-3 w-full",children:[(0,l.jsx)("div",{className:"mt-auto",children:(0,l.jsx)(a,{color:"rgb(245 158 11)",children:n})}),(0,l.jsx)("div",{className:"max-w-[65%] bg-gray-200 p-3 text-sm rounded-xl rounded-bl-none",children:(0,l.jsx)("p",{children:s})})]})}function d(e){let{data:t,auth:s,users:a}=e,r=(0,n.useRef)(null);return console.log("conversation: "+JSON.stringify(t)),console.log("users: "+JSON.stringify(a)),(0,n.useEffect)(()=>{var e;null===(e=r.current)||void 0===e||e.scrollTo(0,r.current.scrollHeight)},[t]),(0,l.jsx)("div",{className:"p-4 space-y-4 overflow-auto",ref:r,children:null==t?void 0:t.map(e=>(0,l.jsx)(i,{right:e.user_id===s.id,content:e.content,username:a.get(e.user_id)},e.id))})}function u(e){let{show:t,setAuth:s,setLogin:a}=e,[o,c]=(0,n.useState)(!1),[i,d]=(0,n.useState)(!1),u=()=>{c(e=>!e)};return(0,l.jsx)("div",{className:"".concat(t?"":"hidden"," bg-gradient-to-b from-orange-400 to-rose-400"),children:(0,l.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,l.jsxs)("div",{className:"px-8 py-6 mt-4 text-left bg-white  max-w-[400px] w-full rounded-xl shadow-lg",children:[(0,l.jsx)("h3",{className:"text-xl text-slate-800 font-semibold",children:o?"Log in with your phone.":"Create your account."}),o?(0,l.jsx)(e=>{let{setAuth:t,setLogin:s}=e,n=async e=>{e.preventDefault();let l=e.target.phone.value;if(""===l){alert("Phone number not found ".concat(l));return}await r.Z.get("http://localhost:8080/users/phone/".concat(l)).then(e=>{let l=e.data;console.log(l),t(l),s(!0)}).catch(e=>console.log(e))};return(0,l.jsxs)("form",{action:"",className:"mt-4 space-y-2",onSubmit:n,children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("label",{className:"text-sm font-light",children:"Phone"}),(0,l.jsx)("input",{required:!0,type:"text",name:"phone",placeholder:"+1111...",className:"w-full px-4 py-2 mt-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-blue-600"})]}),(0,l.jsx)("div",{className:"flex items-baseline justify-between",children:(0,l.jsx)("button",{type:"submit",className:"px-6 py-2 mt-4 text-white bg-violet-600 rounded-lg hover:bg-violet-700 w-full",children:"Submit"})}),(0,l.jsx)("div",{className:"pt-2 space-y-2 text-center",children:(0,l.jsxs)("p",{className:"text-base text-gray-700",children:["Don't have username? ",(0,l.jsx)("button",{onClick:u,className:"text-violet-700 font-light",children:"Create"})]})})]})},{setAuth:s,setLogin:a}):(0,l.jsx)(e=>{let{setAuth:t,setLogin:s}=e,n=async e=>{e.preventDefault();let l=e.target.username.value,n=e.target.phone.value;""!==l&&""!==n&&(await r.Z.post("http://localhost:8080/users/create",{username:l,phone:n}).then(e=>{let l=e.data,n=l.id;console.log(l),console.log(n),t(l),s(!0),r.Z.get("http://localhost:8080/rooms/prepare/".concat(n)).then(e=>{console.log(e.data)})}).catch(e=>console.log(e)),alert("Account successfully created!"))};return(0,l.jsxs)("form",{action:"",className:"mt-4 space-y-2",onSubmit:n,children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("label",{className:"text-sm font-light",children:"Username"}),(0,l.jsx)("input",{required:!0,type:"text",name:"username",placeholder:"Jhon Doe",className:"w-full px-4 py-2 mt-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-blue-600"})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("label",{className:"text-sm font-light",children:"Phone"}),(0,l.jsx)("input",{required:!0,type:"text",name:"phone",placeholder:"+1111...",className:"w-full px-4 py-2 mt-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-blue-600"})]}),(0,l.jsx)("div",{className:"flex items-baseline justify-between",children:(0,l.jsx)("button",{type:"submit",className:"px-6 py-2 mt-4 text-white bg-violet-600 rounded-lg hover:bg-violet-700 w-full",children:"Create"})}),(0,l.jsx)("div",{className:"pt-2 space-y-2 text-center",children:(0,l.jsxs)("p",{className:"text-base text-gray-700",children:["Already have a username? ",(0,l.jsx)("button",{onClick:u,className:"text-violet-700 font-light",children:"Sign In"})]})})]})},{setAuth:s,setLogin:a})]})})})}function x(){let[e,t]=(0,n.useState)(null),[s,o]=(0,n.useState)(!1),[i,x]=(0,n.useState)(!1),[m,h]=(0,n.useState)(!1),[g,f]=function(e,t){let[s,l]=(0,n.useState)(t);return(0,n.useEffect)(()=>{try{let s=window.localStorage.getItem(e),n=s?JSON.parse(s):t;l(n)}catch(e){}},[]),[s,t=>{try{let n=t instanceof Function?t(s):t;l(n),window.localStorage.setItem(e,JSON.stringify(n))}catch(e){}}]}("user",!1),[p,j,v,b]=function(e){let[t,s]=(0,n.useState)(!0),[l,a]=(0,n.useState)([]),o=async e=>{s(!0),e&&await r.Z.get("http://localhost:8080/conversations/".concat(e)).then(e=>{let t=e.data&&e.data.length,l=t?e.data:[];console.log("conversation in useConversation: "+JSON.stringify(l)),s(!1),a(l)}).catch(e=>console.log(e))};return(0,n.useEffect)(()=>o(e),[e]),[t,l,a,o]}(""),[N,w,y]=function(e,t){let[s,l]=(0,n.useState)(null),[a,o]=(0,n.useState)(-1),c=async(e,t)=>{e&&await r.Z.put("http://localhost:8080/room/update}",{room_id:e,last_message:t}).then(e=>{let t=e.data;console.log("last_message new: "+JSON.stringify(t)),o(t.id),l(t.last_message)}).catch(e=>console.log(e))};return(0,n.useEffect)(()=>c({room_id:e,last_message:void 0}),[e]),[s,a,c]}(""),_=e=>{"IN"===e?o(!0):o(!1)},S=(e,t)=>{v(s=>[...s,{content:e,user_id:t}])},E=function(e){let t=(0,n.useRef)(null);return(0,n.useEffect)(()=>{null===t.current&&(t.current=new WebSocket("ws://localhost:8080/ws"),t.current.onopen=()=>console.log("ws opened"),t.current.onclose=()=>console.log("ws closed"))},[]),(0,n.useEffect)(()=>{t.current&&(t.current.onmessage=t=>{console.log("e.data in websocket: "+JSON.stringify(t.data)),e(t.data)})},[]),e=>{t.current&&t.current.send(e)}}(e=>{try{let t=JSON.parse(e);switch(t.chat_type){case"TYPING":_(t.value[0]);return;case"TEXT":S(t.value[0],t.user_id);return}}catch(e){console.log(e)}}),F=()=>{let t={id:0,chat_type:"TYPING",value:["OUT"],room_id:e.id,user_id:g.id};E(JSON.stringify(t))},C=async e=>{e.id&&(await b(e.id),t(e))};return(0,n.useEffect)(()=>h(!g),[g]),(0,l.jsx)("div",{children:i?(0,l.jsx)("div",{className:"".concat(!g&&"hidden"," bg-gradient-to-b from-orange-400 to-rose-400 h-screen p-12"),children:(0,l.jsxs)("main",{className:"flex w-full max-w-[1020px] h-[700px] mx-auto bg-[#FAF9FE] rounded-[25px] backdrop-opacity-30 opacity-95",children:[(0,l.jsxs)("aside",{className:"bg-[#F0EEF5] w-[325px] h-[700px] rounded-l-[25px] p-4 overflow-auto relative",children:[(0,l.jsx)(c,{onChatChange:C,userId:g.id}),(0,l.jsx)("button",{onClick:()=>{window.localStorage.removeItem("user"),x(!1),f(!1)},className:"text-xs w-full max-w-[295px] p-3 rounded-[10px] bg-violet-200 font-semibold text-violet-600 text-center absolute bottom-4",children:"LOG OUT"})]}),(null==e?void 0:e.id)&&(0,l.jsxs)("section",{className:"rounded-r-[25px] w-full max-w-[690px] grid grid-rows-[80px_minmax(450px,_1fr)_65px]",children:[(0,l.jsxs)("div",{className:"rounded-tr-[25px] w-ful",children:[(0,l.jsxs)("div",{className:"flex gap-3 p-3 items-center",children:[(0,l.jsx)(a,{color:"rgb(245 158 11)",children:e.users.get_target_user(g.id)}),(0,l.jsxs)("div",{children:[(0,l.jsx)("p",{className:"font-semibold text-gray-600 text-base",children:e.users.get_target_user(g.id)}),(0,l.jsx)("div",{className:"text-xs text-gray-400",children:s?"Typing...":"10:15 AM"})]})]}),(0,l.jsx)("hr",{className:"bg-[#F0EEF5]"})]}),p&&e.id&&(0,l.jsx)("p",{className:"px-4 text-slate-500",children:"Loading conversation..."}),(0,l.jsx)(d,{data:j,auth:g,users:e.users}),(0,l.jsx)("div",{className:"w-full",children:(0,l.jsxs)("form",{onSubmit:t=>{t.preventDefault();let s=t.target.message.value;if(""===s)return;if(!e.id){alert("Please select chat room!");return}let l={id:0,chat_type:"TEXT",value:[s],room_id:e.id,user_id:g.id};E(JSON.stringify(l)),t.target.message.value="",S(s,g.id),F(),y(l.id,l.last_message)},className:"flex gap-2 items-center rounded-full border border-violet-500 bg-violet-200 p-1 m-2",children:[(0,l.jsx)("input",{onBlur:F,onFocus:()=>{let t={id:0,chat_type:"TYPING",value:["IN"],room_id:e.id,user_id:g.id};E(JSON.stringify(t))},name:"message",className:"p-2 placeholder-gray-600 text-sm w-full rounded-full bg-violet-200 focus:outline-none",placeholder:"Type your message here..."}),(0,l.jsx)("button",{type:"submit",className:"bg-violet-500 rounded-full py-2 px-6 font-semibold text-white text-sm",children:"Sent"})]})})]})]})}):(0,l.jsx)(u,{show:m,setAuth:f,setLogin:x})})}}},function(e){e.O(0,[237,774,888,179],function(){return e(e.s=5557)}),_N_E=e.O()}]);